<%= h1 "Inspect #{params[:object_type].singularize} #{params[:object_id]}", size: "xl" %>

<pre class="mermaid" style="overflow-x: auto; width: 100vw; margin-left: calc(50% - 50vw); display: grid; place-items: center;">
  <%= @mermaid.html_safe %>
</pre>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        flowchart: {
          securityLevel: 'loose',
          useMaxWidth: false
        }
    });
</script>

<%= render AppDetailsComponent.new(summary: "Raw mermaid", expander: true, open: false) do %>
  <pre class="nhsuk-u-font-family-monospace nhsuk-u-margin-0" style="font-size: small;"><%= @mermaid %></pre>
<% end %>

<%= render AppDetailsComponent.new(summary: "Graph options", expander: true, open: true) do %>
  <%= form_with url: inspect_graph_path(object_type: params[:object_type], object_id: params[:object_id]), method: :get, local: true do |form| %>
    <!-- TODO add UI to allow changing order of nodes -->
    <% @traversals_config.keys.sort_by { |r| r.name.to_s.humanize }.each do |type| %>
      <div class="nhsuk-form-group">
        <h1 class="nhsuk-heading-m"><%= type.to_s.humanize %></h1>

        <!-- TODO: sort out bold -->
        <%= form.govuk_check_boxes_fieldset "relationships[#{type}]", legend: { text: safe_join(["Select relationships to include for ", tag.span(type, class: "nhsuk-u-font-weight-bold")]), size: "s" } do %>
          <% type.to_s.classify.constantize.reflect_on_all_associations.sort_by { |r|
            [
              params.dig(:relationships, type)&.include?(r.name.to_s) ? 0 : 1,
              r.name.to_s.humanize
            ]
          }.each do |r| %>
            <%= form.govuk_check_box "relationships[#{type}]", r.name, label: { text: r.name.to_s.humanize }, checked: params.dig(:relationships, type)&.include?(r.name.to_s) %>
          <% end %>
        <% end %>

        <br>

        <%= form.label "additional_ids[#{type}]", safe_join(["Additional ", tag.span(type, class: "nhsuk-u-font-weight-bold"), " IDs (comma separated)"]), class: "nhsuk-label" %>
        <%= form.search_field "additional_ids[#{type}]", value: params.dig(:additional_ids, type), class: "nhsuk-input" %>
        <hr class="nhsuk-rule">
      </div>
    <% end %>

    <%= form.govuk_submit "Update graph", name: nil %>
  <% end %>
<% end %>